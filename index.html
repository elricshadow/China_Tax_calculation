<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>中国税费计算器（v16 - 含增值税附加与所得税计算）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: "Segoe UI", "PingFang SC", Arial, sans-serif;
            background: linear-gradient(120deg, #eaf4ff 0%, #f7f7f7 100%);
            margin: 0;
            min-height: 100vh;
        }
        .container {
            background: #fff;
            padding: 26px 20px;
            border-radius: 12px;
            max-width: 820px;
            margin: 30px auto;
            box-shadow: 0 8px 36px rgba(47, 91, 216, 0.08);
        }
        h2 {
            text-align: center;
            color: #2f5bd8;
            margin-bottom: 12px;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .section-title {
            font-size: 1.02rem;
            color: #1e4aa7;
            margin: 16px 0 8px;
            font-weight: 700;
            border-left: 4px solid #3d5afe;
            padding-left: 10px;
        }
        label { display:block; margin:8px 0 6px; color:#2a5ea6; font-size:0.98rem; }
        .flex-row { display:flex; gap:10px; align-items:center; }
        .flex-row > * { flex:1; }
        input[type="number"], select {
            padding:10px 12px;
            border-radius:8px;
            border:1.2px solid #d6e7ff;
            background:#fbfeff;
            font-size:1rem;
            outline:none;
        }
        input[type="number"]:focus, select:focus { border-color:#3d5afe; box-shadow:0 6px 18px rgba(61,90,254,0.06); }
        .amount-short { width:190px; max-width:46%; }
        .rate-input { max-width:150px; }
        .btn { width:100%; padding:12px; background:linear-gradient(90deg,#3d5afe 40%, #6fb7ff 100%); color:#fff; border:none; border-radius:10px; cursor:pointer; font-size:1rem; margin-top:12px; }
        .result { margin-top:14px; padding:12px; border-radius:8px; background:linear-gradient(180deg,#fbfeff,#f5fbff); box-shadow:0 6px 18px rgba(19,87,209,0.04); font-size:1rem; }
        .tax-type { font-weight:700; margin:10px 0 6px; color:#2a5ea6; }
        .hint { color:#ff9800; font-weight:600; margin:8px 0; }
        .err { color:#d32f2f; font-weight:700; padding:8px 0; text-align:center; }
        /* 城建税卡片 */
        .tax-city-row { display:flex; gap:10px; margin:10px 0; }
        .tax-city-card { flex:1; text-align:center; padding:8px 6px; border-radius:8px; border:1.2px solid #e6f0ff; background:#fbfeff; cursor:pointer; transition:all .15s; user-select:none; }
        .tax-city-card.selected { border-color:#3d5afe; background:linear-gradient(180deg,#eaf2ff,#e1f0ff); box-shadow:0 6px 16px rgba(61,90,254,0.07); color:#2a4fc6; font-weight:700; }
        .tax-city-name { color:#1f4ea0; font-size:0.98rem; }
        .tax-city-rate { color:#2e7d32; margin-top:6px; font-weight:700; }
        .small-row { display:flex; gap:10px; align-items:center; margin-top:8px; }
        .small-row > * { flex: none; }
        .checkbox { transform:scale(1.05); margin-right:6px; vertical-align:middle; }

        /* 两栏布局 */
        .columns { display:flex; gap:20px; flex-wrap:wrap; }
        .col { flex:1; min-width:300px; }

        @media (max-width:900px) {
            .container{padding:18px;margin:16px;}
            .amount-short{width:130px;}
            .rate-input{max-width:120px;}
            .tax-city-row{gap:6px;}
            .columns { flex-direction:column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>中国税费计算器（v16）</h2>

        <div class="columns">
            <!-- 左列：增值税 -->
            <div class="col">
                <div class="section-title">增值税计算</div>

                <label for="amount">金额（元）</label>
                <div class="flex-row">
                    <input type="number" id="amount" class="amount-short" min="0" step="0.01" placeholder="金额" />
                    <select id="mode" title="金额模式" style="max-width:160px;">
                        <option value="exclusive">未含税（基数）</option>
                        <option value="inclusive">含税（倒算）</option>
                    </select>
                </div>

                <label for="rate-select">税率</label>
                <div class="flex-row">
                    <select id="rate-select" onchange="updateRateInput()">
                        <option value="13">13%</option>
                        <option value="11">11%</option>
                        <option value="10">10%</option>
                        <option value="9">9%</option>
                        <option value="6">6%</option>
                        <option value="3">3%</option>
                        <option value="1">1%</option>
                        <option value="0">0%</option>
                        <option value="other">自定义</option>
                    </select>
                    <input type="number" id="rate" class="rate-input" min="0" max="100" step="0.01" value="13" oninput="selectOtherRate()" />
                </div>

                <div class="section-title" style="margin-top:12px;">城建税 / 附加费设置</div>
                <div style="font-size:0.95rem; color:#1565c0; margin-bottom:6px;">选择城建税适用区域（教育费附加 3%，地方教育附加 2%，按已缴增值税额计征）</div>
                <div class="tax-city-row" id="tax-city-row">
                    <div class="tax-city-card selected" data-rate="0.07" onclick="selectCity(this)">
                        <div class="tax-city-name">城市</div>
                        <div class="tax-city-rate">城建税 7%</div>
                    </div>
                    <div class="tax-city-card" data-rate="0.05" onclick="selectCity(this)">
                        <div class="tax-city-name">县/镇</div>
                        <div class="tax-city-rate">城建税 5%</div>
                    </div>
                    <div class="tax-city-card" data-rate="0.01" onclick="selectCity(this)">
                        <div class="tax-city-name">乡/村</div>
                        <div class="tax-city-rate">城建税 1%</div>
                    </div>
                </div>

                <div class="small-row" style="margin-top:6px;">
                    <input type="checkbox" id="apply-exempt" class="checkbox" />
                    <label for="apply-exempt" style="margin:0;">按小规模免征计算（若符合小规模纳税人免征条件，则勾选）</label>
                </div>

                <div style="font-size:0.92rem; color:#666; margin-top:8px;">
                    小规模免征参考阈值：未含税月销售额 ≤ ¥100,000（仅供参考，最终以税务机关认定为准）
                </div>

                <button class="btn" onclick="calculateVAT()">💰 计算增值税与附加税</button>

                <div class="result" id="vat-result" aria-live="polite"></div>
            </div>

            <!-- 右列：个体与个人所得税（保留） -->
            <div class="col">
                <!-- 个体工商户所得税（月度） -->
                <div class="section-title">个体工商户所得税计算（月度）</div>

                <label for="biz-income">经营收入（元）</label>
                <input type="number" id="biz-income" min="0" step="0.01" placeholder="请输入经营收入" />

                <div class="flex-row" style="margin-top:6px;">
                    <label style="margin:0;">月度起征点</label>
                    <select id="biz-threshold-select" onchange="updateBizThresholdInput()" style="max-width:160px;">
                        <option value="5000">5000元</option>
                        <option value="10000">10000元</option>
                        <option value="20000">20000元</option>
                        <option value="30000">30000元</option>
                        <option value="other">自定义</option>
                    </select>
                </div>
                <div class="flex-row" style="margin-top:8px;">
                    <input type="number" id="biz-threshold" min="0" step="0.01" placeholder="自定义起征点" value="5000" />
                    <input type="number" id="biz-deduct" min="0" step="0.01" placeholder="专项扣除（可选）" />
                </div>

                <button class="btn" onclick="handleCalculateBiz()">🏢 计算个体工商户所得税</button>
                <div class="result" id="biz-result" aria-live="polite"></div>

                <!-- 个人所得税（工资薪金） -->
                <div class="section-title" style="margin-top:18px;">个人所得税计算（工资薪金）</div>

                <label for="salary">税前工资（元）</label>
                <input type="number" id="salary" min="0" step="0.01" placeholder="请输入税前工资" />

                <div class="flex-row" style="margin-top:6px;">
                    <label style="margin:0;">起征点</label>
                    <select id="salary-threshold-select" onchange="updateSalaryThresholdInput()" style="max-width:160px;">
                        <option value="5000">5000元（默认）</option>
                        <option value="8000">8000元</option>
                        <option value="10000">10000元</option>
                        <option value="other">自定义</option>
                    </select>
                </div>
                <div class="flex-row" style="margin-top:8px;">
                    <input type="number" id="salary-threshold" min="0" step="0.01" placeholder="自定义起征点" value="5000" />
                    <div style="flex:1"></div>
                </div>

                <button class="btn" onclick="handleCalculatePersonal()">🧾 计算个人所得税</button>
                <div class="result" id="income-result" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <script>
        /* ---------------------
           城建税卡片与税率选择逻辑
           --------------------- */
        function selectCity(card) {
            document.querySelectorAll('.tax-city-card').forEach(function(c){ c.classList.remove('selected'); });
            card.classList.add('selected');
        }
        function getSelectedCityRate() {
            var sel = document.querySelector('.tax-city-card.selected');
            return sel ? parseFloat(sel.getAttribute('data-rate')) : 0.07;
        }

        function updateRateInput() {
            var sel = document.getElementById('rate-select');
            var input = document.getElementById('rate');
            if (sel.value === 'other') {
                input.value = '';
                input.focus();
            } else {
                input.value = sel.value;
            }
        }
        function selectOtherRate() {
            var input = document.getElementById('rate');
            var sel = document.getElementById('rate-select');
            var presets = ['13','11','10','9','6','3','1','0'];
            if (!presets.includes(String(input.value))) sel.value = 'other';
        }

        /* ---------------------
           增值税 + 附加税 计算（v16 要求）
           --------------------- */
        function calculateVAT() {
            var amountRaw = parseFloat(document.getElementById('amount').value);
            var mode = document.getElementById('mode').value; // exclusive | inclusive
            var rate = parseFloat(document.getElementById('rate').value);
            var vatResultEl = document.getElementById('vat-result');
            var cityRate = getSelectedCityRate();
            var applyExempt = document.getElementById('apply-exempt').checked;

            if (isNaN(amountRaw) || amountRaw < 0 || isNaN(rate) || rate < 0 || rate > 100) {
                vatResultEl.innerHTML = '<div class="err">请输入有效的金额和税率（税率 0 - 100）</div>';
                return;
            }

            var r = rate / 100;
            var taxableBase_excl = 0;
            var vatPayable = 0;
            var totalWithVat = 0;
            var vatInside = 0;
            var amountWithoutTax = 0;

            if (mode === 'exclusive') {
                taxableBase_excl = amountRaw;
                vatPayable = taxableBase_excl * r;
                totalWithVat = taxableBase_excl + vatPayable;
                vatInside = vatPayable;
                amountWithoutTax = taxableBase_excl;
            } else {
                totalWithVat = amountRaw;
                vatInside = amountRaw * r / (1 + r);
                amountWithoutTax = amountRaw / (1 + r);
                taxableBase_excl = amountWithoutTax;
                vatPayable = vatInside;
            }

            // 小规模免征参考阈值（提示）
            var smallScaleThreshold = 100000; // 10 万
            var isSmallScaleCandidate = taxableBase_excl <= smallScaleThreshold;
            var smallScaleHint = isSmallScaleCandidate ? ('<div class="hint">提示：该未含税金额 ≤ ¥' + smallScaleThreshold.toLocaleString() + '，可能符合小规模纳税人免征条件（仅供参考）。</div>') : '';

            // 如果用户勾选免征并且为候选，则实际应缴为0
            var effectiveVat = vatPayable;
            if (applyExempt && isSmallScaleCandidate) effectiveVat = 0;

            // 附加税费（按已缴增值税额计征）
            var cityTax = effectiveVat * cityRate;
            var eduSurcharge = effectiveVat * 0.03;      // 教育费附加 3%
            var localEduSurcharge = effectiveVat * 0.02; // 地方教育附加 2%
            var totalSurcharges = cityTax + eduSurcharge + localEduSurcharge;

            // 构建输出 HTML
            var html = '';
            if (smallScaleHint) html += smallScaleHint;

            html += '<div class="tax-type">增值税（' + (mode === 'exclusive' ? '未含税基数' : '含税金额倒算') + '）</div>';
            html += '<div>未含税金额（基数）： <b style="color:#1565c0;">' + taxableBase_excl.toFixed(2) + '</b> 元</div>';
            html += '<div>增值税（税率 ' + rate.toFixed(2) + '%）： <b style="color:#43a047;">' + vatPayable.toFixed(2) + '</b> 元</div>';
            if (applyExempt && isSmallScaleCandidate) {
                html += '<div style="color:#e65100; margin-top:6px;"><b>已按小规模免征：增值税及附加税均计为 0.00 元（仅在符合条件并经税务机关认定时适用）</b></div>';
            }
            html += '<div>含税总额： <b style="color:#3d5afe;">' + totalWithVat.toFixed(2) + '</b> 元</div>';

            html += '<div class="tax-type">价内税（倒算示例）</div>';
            html += '<div>含税金额： <b style="color:#1565c0;">' + totalWithVat.toFixed(2) + '</b> 元</div>';
            html += '<div>倒算增值税： <b style="color:#e65100;">' + vatInside.toFixed(2) + '</b> 元</div>';
            html += '<div>倒算未含税金额： <b style="color:#00838f;">' + amountWithoutTax.toFixed(2) + '</b> 元</div>';

            html += '<div class="tax-type">附加税费（按已缴增值税额计征）</div>';
            html += '<div>城建税（适用率 ' + (cityRate * 100).toFixed(2) + '%）： <b>' + cityTax.toFixed(2) + '</b> 元</div>';
            html += '<div>教育费附加（3%）： <b>' + eduSurcharge.toFixed(2) + '</b> 元</div>';
            html += '<div>地方教育附加（2%）： <b>' + localEduSurcharge.toFixed(2) + '</b> 元</div>';
            html += '<div style="margin-top:6px;">附加税合计： <b style="color:#e65100;">' + totalSurcharges.toFixed(2) + '</b> 元</div>';

            if (isSmallScaleCandidate && !applyExempt) {
                html += '<div class="tax-type" style="margin-top:10px;">若申报小规模免征（参考）</div>';
                html += '<div>增值税：<b style="color:#43a047;">0.00</b> 元</div>';
                html += '<div>城建税：<b>0.00</b> 元；教育费附加：<b>0.00</b> 元；地方教育附加：<b>0.00</b> 元</div>';
                html += '<div class="hint" style="margin-top:6px;">注：是否免征以税务机关认定为准，本工具仅作参考。</div>';
            }

            vatResultEl.innerHTML = html;
            vatResultEl.focus && vatResultEl.focus();
        }

        /* =========================
           所得税计算（嵌入 v16 页面）
           包括：
           - getPersonalSalaryTax
           - getBizIncomeTaxMonthly
           并提供页面调用处理函数
           ========================= */

        function round2(v) {
          return Math.round((v + Number.EPSILON) * 100) / 100;
        }

        function getPersonalBracket(taxable) {
          var rate = 0, q = 0, level = '';
          if (taxable <= 3000) {
            rate = 3; q = 0; level = '第1级 (≤3,000)';
          } else if (taxable <= 12000) {
            rate = 10; q = 210; level = '第2级 (3,000~12,000)';
          } else if (taxable <= 25000) {
            rate = 20; q = 1410; level = '第3级 (12,000~25,000)';
          } else if (taxable <= 35000) {
            rate = 25; q = 2660; level = '第4级 (25,000~35,000)';
          } else if (taxable <= 55000) {
            rate = 30; q = 4410; level = '第5级 (35,000~55,000)';
          } else if (taxable <= 80000) {
            rate = 35; q = 7160; level = '第6级 (55,000~80,000)';
          } else {
            rate = 45; q = 15160; level = '第7级 (>80,000)';
          }
          return { rate: rate, quickDeduction: q, level: level };
        }

        function getPersonalSalaryTax(salary, options) {
          options = options || {};
          var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
          var keepNegative = !!options.keepNegativeTaxable;

          if (isNaN(salary) || salary < 0) {
            throw new Error('salary 必须为非负数字');
          }

          var taxable = round2(salary - threshold);
          if (!keepNegative && taxable < 0) taxable = 0;

          if (taxable === 0) {
            return {
              salary: round2(salary),
              threshold: round2(threshold),
              taxable: taxable,
              rate: 0,
              quickDeduction: 0,
              tax: 0,
              net: round2(salary),
              bracket: '免税'
            };
          }

          var bracket = getPersonalBracket(taxable);
          var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
          if (tax < 0) tax = 0;
          var net = round2(salary - tax);

          return {
            salary: round2(salary),
            threshold: round2(threshold),
            taxable: round2(taxable),
            rate: bracket.rate,
            quickDeduction: bracket.quickDeduction,
            tax: tax,
            net: net,
            bracket: bracket.level
          };
        }

        function getBizBracketMonthly(taxable) {
          var rate = 0, q = 0, level = '';
          if (taxable <= 30000) {
            rate = 5; q = 0; level = '第1级 (≤30,000)';
          } else if (taxable <= 90000) {
            rate = 10; q = 1500; level = '第2级 (30,000~90,000)';
          } else if (taxable <= 300000) {
            rate = 20; q = 10500; level = '第3级 (90,000~300,000)';
          } else if (taxable <= 500000) {
            rate = 30; q = 40500; level = '第4级 (300,000~500,000)';
          } else {
            rate = 35; q = 65500; level = '第5级 (>500,000)';
          }
          return { rate: rate, quickDeduction: q, level: level };
        }

        function getBizIncomeTaxMonthly(income, options) {
          options = options || {};
          var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
          var deduction = typeof options.deduction === 'number' ? options.deduction : 0;
          var keepNegative = !!options.keepNegativeTaxable;

          if (isNaN(income) || income < 0) {
            throw new Error('income 必须为非负数字');
          }
          if (isNaN(deduction) || deduction < 0) deduction = 0;
          if (isNaN(threshold) || threshold < 0) threshold = 5000;

          var taxable = round2(income - threshold - deduction);
          if (!keepNegative && taxable < 0) taxable = 0;

          if (taxable === 0) {
            return {
              income: round2(income),
              threshold: round2(threshold),
              deduction: round2(deduction),
              taxable: taxable,
              rate: 0,
              quickDeduction: 0,
              tax: 0,
              net: round2(income),
              bracket: '免税'
            };
          }

          var bracket = getBizBracketMonthly(taxable);
          var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
          if (tax < 0) tax = 0;
          var net = round2(income - tax);

          return {
            income: round2(income),
            threshold: round2(threshold),
            deduction: round2(deduction),
            taxable: round2(taxable),
            rate: bracket.rate,
            quickDeduction: bracket.quickDeduction,
            tax: tax,
            net: net,
            bracket: bracket.level
          };
        }

        // 暴露到 window 全局
        window.getPersonalSalaryTax = getPersonalSalaryTax;
        window.getBizIncomeTaxMonthly = getBizIncomeTaxMonthly;

        /* =========================
           页面交互：显示个体与个人所得税计算结果
           ========================= */

        function updateBizThresholdInput() {
            var select = document.getElementById('biz-threshold-select');
            var input = document.getElementById('biz-threshold');
            if (select.value === "other") {
                input.value = "";
                input.focus();
            } else {
                input.value = select.value;
            }
        }
        function updateSalaryThresholdInput() {
            var select = document.getElementById('salary-threshold-select');
            var input = document.getElementById('salary-threshold');
            if (select.value === "other") {
                input.value = "";
                input.focus();
            } else {
                input.value = select.value;
            }
        }

        function handleCalculateBiz() {
            var income = parseFloat(document.getElementById('biz-income').value);
            var threshold = parseFloat(document.getElementById('biz-threshold').value);
            var deduction = parseFloat(document.getElementById('biz-deduct').value);
            var resEl = document.getElementById('biz-result');

            if (isNaN(income) || income < 0) {
                resEl.innerHTML = '<div class="err">请输入有效的经营收入</div>';
                return;
            }
            if (isNaN(threshold) || threshold < 0) threshold = 5000;
            if (isNaN(deduction) || deduction < 0) deduction = 0;

            try {
                var result = getBizIncomeTaxMonthly(income, { threshold: threshold, deduction: deduction });
                var html = '<div class="tax-type">个体工商户所得税（月度）</div>';
                html += '<div>经营收入： <b>' + result.income.toFixed(2) + '</b> 元</div>';
                html += '<div>起征点： <b>' + result.threshold.toFixed(2) + '</b> 元</div>';
                html += '<div>专项扣除： <b>' + result.deduction.toFixed(2) + '</b> 元</div>';
                html += '<div>应纳税所得额： <b>' + result.taxable.toFixed(2) + '</b> 元</div>';
                html += '<div>适用税率： <b>' + result.rate + '%</b>（' + result.bracket + '，速算扣除数：' + result.quickDeduction + ' 元）</div>';
                html += '<div>应纳税额： <b style="color:#e65100;">' + result.tax.toFixed(2) + '</b> 元</div>';
                html += '<div>税后收入： <b style="color:#43a047;">' + result.net.toFixed(2) + '</b> 元</div>';
                resEl.innerHTML = html;
            } catch (e) {
                resEl.innerHTML = '<div class="err">' + e.message + '</div>';
            }
        }

        function handleCalculatePersonal() {
            var salary = parseFloat(document.getElementById('salary').value);
            var threshold = parseFloat(document.getElementById('salary-threshold').value);
            var resEl = document.getElementById('income-result');

            if (isNaN(salary) || salary < 0) {
                resEl.innerHTML = '<div class="err">请输入有效的税前工资</div>';
                return;
            }
            if (isNaN(threshold) || threshold < 0) threshold = 5000;

            try {
                var result = getPersonalSalaryTax(salary, { threshold: threshold });
                var html = '<div class="tax-type">个人所得税（工资薪金）</div>';
                html += '<div>税前工资： <b>' + result.salary.toFixed(2) + '</b> 元</div>';
                html += '<div>起征点： <b>' + result.threshold.toFixed(2) + '</b> 元</div>';
                html += '<div>应纳税所得额： <b>' + result.taxable.toFixed(2) + '</b> 元</div>';
                html += '<div>适用税率： <b>' + result.rate + '%</b>（' + result.bracket + '，速算扣除数：' + result.quickDeduction + ' 元）</div>';
                html += '<div>应纳税额： <b style="color:#e65100;">' + result.tax.toFixed(2) + '</b> 元</div>';
                html += '<div>实发工资： <b style="color:#43a047;">' + result.net.toFixed(2) + '</b> 元</div>';
                resEl.innerHTML = html;
            } catch (e) {
                resEl.innerHTML = '<div class="err">' + e.message + '</div>';
            }
        }

        // init: ensure selected city card
        (function(){ if (!document.querySelector('.tax-city-card.selected')) { var f=document.querySelector('.tax-city-card'); if (f) f.classList.add('selected'); } })();
    </script>
</body>
</html>
