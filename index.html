<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>ä¸­å›½ç¨è´¹è®¡ç®—å™¨-å«å¢å€¼ç¨åŠæ‰€å¾—ç¨è®¡ç®—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f8ff;
      --card:#ffffff;
      --primary:#2f5bd8;
      --accent:#6fb7ff;
      --muted:#6b7a9a;
      --success:#2e7d32;
      --danger:#e53935;
      --glass: rgba(255,255,255,0.75);
      --radius:12px;
      --shadow: 0 8px 30px rgba(47,91,216,0.08);
      --gap:18px;
      --maxw:1100px;
    }

    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg,var(--bg), #ffffff 60%);
      font-family: "Inter", "Segoe UI", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
      color:#1f2a44;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      max-width:var(--maxw);
      margin:28px auto;
      padding:20px;
    }

    header.app-header{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }
    .logo {
      width:56px;
      height:56px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      box-shadow: 0 6px 18px rgba(47,91,216,0.12);
      flex-shrink:0;
    }
    .title-group{
      display:flex;
      flex-direction:column;
    }
    h1{
      margin:0;
      font-size:1.15rem;
      color:var(--primary);
      letter-spacing:0.6px;
    }
    .subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size:0.9rem;
    }

    main.grid {
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:var(--gap);
      align-items:start;
    }

    /* Left column (main calculators) */
    .main-card {
      background: var(--card);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* Right column (results, reference) */
    .side-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .section {
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.9));
      border-radius:10px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid rgba(47,91,216,0.03);
    }
    .section .section-title {
      display:flex;
      gap:8px;
      align-items:center;
      font-weight:700;
      color:var(--primary);
    }
    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    label.small {
      font-size:0.9rem;
      color:var(--muted);
      margin-bottom:6px;
    }

    input[type="number"], select {
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(47,91,216,0.12);
      background: #fff;
      font-size:0.98rem;
      color:#111827;
      outline:none;
      min-width:0;
      box-sizing:border-box;
    }
    input[type="number"]:focus, select:focus { box-shadow:0 6px 18px rgba(47,91,216,0.06); border-color:var(--primary); }

    .row {
      display:flex;
      gap:10px;
      align-items:center;
      width:100%;
    }
    .row .flex-1 { flex:1; }
    .row .w-160 { width:160px; }
    .row .w-120 { width:120px; }
    .row .w-80  { width:80px; }

    .btn {
      padding:11px 14px;
      background:linear-gradient(90deg,var(--primary),var(--accent));
      color:#fff;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 8px 20px rgba(47,91,216,0.12);
      transition:transform .12s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.ghost {
      background:transparent;
      color:var(--primary);
      border:1px solid rgba(47,91,216,0.08);
      box-shadow:none;
    }

    /* city tax cards */
    .tax-city-row {
      display:flex;
      gap:10px;
    }
    .tax-city-card {
      flex:1;
      padding:10px 8px;
      border-radius:8px;
      border:1px solid rgba(47,91,216,0.06);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      text-align:center;
      cursor:pointer;
      transition:all .12s;
      color:var(--muted);
      font-weight:600;
      font-size:0.95rem;
    }
    .tax-city-card .rate { margin-top:6px; color:var(--success); font-weight:800; }
    .tax-city-card.selected {
      border-color: rgba(47,91,216,0.18);
      box-shadow: 0 8px 20px rgba(47,91,216,0.06);
      color:var(--primary);
      background: linear-gradient(180deg,#eef5ff,#e6f0ff);
    }

    /* results layout */
    .result .line { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(31,42,68,0.04); }
    .result .line:last-child { border-bottom:none; }
    .muted { color:var(--muted); font-size:0.92rem; }
    .value { color:#0b3b8a; font-weight:700; }

    .small-note { font-size:0.88rem; color:var(--muted); }

    /* Responsive */
    @media (max-width:980px){
      main.grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="app-header" aria-hidden="false">
      <div class="logo">ç¨</div>
      <div class="title-group">
        <h1>ä¸­å›½ç¨è´¹è®¡ç®—å™¨ </h1>
        <div class="subtitle">å¢å€¼ç¨ï¼ˆå«é™„åŠ ï¼‰ Â· ä¸ªä½“å·¥å•†æˆ· Â· ä¸ªäººæ‰€å¾—ç¨</div>
      </div>
    </header>

    <main class="grid" role="main">
      <!-- LEFT: calculators -->
      <section class="main-card" aria-label="è®¡ç®—å™¨">
        <!-- VAT Section -->
        <div class="section" id="vat-section">
          <div class="section-title">ğŸ§¾ å¢å€¼ç¨è®¡ç®—</div>

          <div class="row">
            <div class="flex-1">
              <label class="small">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
              <input id="amount" type="number" min="0" step="0.01" placeholder="è¯·è¾“å…¥é‡‘é¢">
            </div>
            <div class="w-160">
              <label class="small">é‡‘é¢æ¨¡å¼</label>
              <select id="mode" title="é‡‘é¢æ¨¡å¼">
                <option value="exclusive">æœªå«ç¨ï¼ˆåŸºæ•°ï¼‰</option>
                <option value="inclusive">å«ç¨ï¼ˆå€’ç®—ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="flex-1">
              <label class="small">ç¨ç‡ï¼ˆ%ï¼‰</label>
              <select id="rate-select" onchange="updateRateInput()">
                <option value="13">13%</option>
                <option value="11">11%</option>
                <option value="10">10%</option>
                <option value="9">9%</option>
                <option value="6">6%</option>
                <option value="3">3%</option>
                <option value="1">1%</option>
                <option value="0">0%</option>
                <option value="other">è‡ªå®šä¹‰</option>
              </select>
            </div>
            <div class="w-120">
              <label class="small">ç¨ç‡æ‰‹åŠ¨</label>
              <input id="rate" class="" type="number" min="0" max="100" step="0.01" value="13">
            </div>
            <div class="w-80" style="align-self:flex-end;">
              <button class="btn" onclick="calculateVAT()">è®¡ç®—</button>
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="small-note">é™„ï¼šå°è§„æ¨¡å…å¾å‚è€ƒé˜ˆå€¼ â‰¤ Â¥100,000ï¼ˆè¯·æŒ‰ç¨åŠ¡æœºå…³è®¤å®šä¸ºå‡†ï¼‰</div>
          </div>
        </div>

        <!-- Individual Biz (ä¸ªä½“å·¥å•†æˆ·) -->
        <div class="section" id="biz-section">
          <div class="section-title">ğŸ¢ ä¸ªä½“å·¥å•†æˆ·æ‰€å¾—ç¨ï¼ˆæŒ‰æœˆï¼‰</div>

          <div class="row">
            <div class="flex-1">
              <label class="small">ç»è¥æ”¶å…¥ï¼ˆå…ƒï¼‰</label>
              <input id="biz-income" type="number" min="0" step="0.01" placeholder="è¯·è¾“å…¥ç»è¥æ”¶å…¥">
            </div>
            <div class="w-160">
              <label class="small">æœˆåº¦èµ·å¾ç‚¹</label>
              <select id="biz-threshold-select" onchange="updateBizThresholdInput()">
                <option value="5000">5000å…ƒ</option>
                <option value="10000">10000å…ƒ</option>
                <option value="20000">20000å…ƒ</option>
                <option value="30000">30000å…ƒ</option>
                <option value="other">è‡ªå®šä¹‰</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="flex-1">
              <label class="small">è‡ªå®šä¹‰èµ·å¾ç‚¹ / ä¸“é¡¹æ‰£é™¤</label>
              <div style="display:flex; gap:8px;">
                <input id="biz-threshold" type="number" placeholder="è‡ªå®šä¹‰èµ·å¾ç‚¹" min="0" step="0.01">
                <input id="biz-deduct" type="number" placeholder="ä¸“é¡¹æ‰£é™¤ï¼ˆå¯é€‰ï¼‰" min="0" step="0.01">
              </div>
            </div>
            <div style="width:80px; align-self:flex-end;">
              <button class="btn" onclick="handleCalculateBiz()">è®¡ç®—</button>
            </div>
          </div>
        </div>

        <!-- Personal Salary Tax -->
        <div class="section" id="personal-section">
          <div class="section-title">ğŸ§¾ ä¸ªäººæ‰€å¾—ç¨ï¼ˆå·¥èµ„è–ªé‡‘ï¼‰</div>

          <div class="row">
            <div class="flex-1">
              <label class="small">ç¨å‰å·¥èµ„ï¼ˆå…ƒï¼‰</label>
              <input id="salary" type="number" min="0" step="0.01" placeholder="è¯·è¾“å…¥ç¨å‰å·¥èµ„">
            </div>
            <div class="w-160">
              <label class="small">èµ·å¾ç‚¹</label>
              <select id="salary-threshold-select" onchange="updateSalaryThresholdInput()">
                <option value="5000">5000å…ƒï¼ˆé»˜è®¤ï¼‰</option>
                <option value="8000">8000å…ƒ</option>
                <option value="10000">10000å…ƒ</option>
                <option value="other">è‡ªå®šä¹‰</option>
              </select>
            </div>
          </div>

          <div class="row" style="align-items:flex-end;">
            <div class="flex-1">
              <input id="salary-threshold" type="number" placeholder="è‡ªå®šä¹‰èµ·å¾ç‚¹" min="0" step="0.01">
              <div class="small-note" style="margin-top:8px;">åœç”¨ç¨å‰ä¸“é¡¹æ˜ç»†ï¼Œå¦‚éœ€ç²¾ç¡®è®¡ç®—å¯æ‰©å±•ä¸“é¡¹æ‰£é™¤é¡¹ã€‚</div>
            </div>
            <div style="width:80px;">
              <button class="btn" onclick="handleCalculatePersonal()">è®¡ç®—</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: results and controls -->
      <aside class="side-card" aria-label="ç»“æœé¢æ¿">
        <!-- VAT result + city card -->
        <div style="display:flex; flex-direction:column; gap:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; color:var(--primary);">å¢å€¼ç¨ä¸é™„åŠ ç¨ ç»“æœ</div>
            <div class="small-note">ç»“æœä¼šåœ¨æ­¤æ˜¾ç¤º</div>
          </div>

          <div style="display:flex; flex-direction:column; gap:8px;">
            <div class="tax-city-row" id="tax-city-row">
              <div class="tax-city-card selected" data-rate="0.07" onclick="selectCity(this)">
                åŸå¸‚ <div class="rate">7%</div>
              </div>
              <div class="tax-city-card" data-rate="0.05" onclick="selectCity(this)">
                å¿/é•‡ <div class="rate">5%</div>
              </div>
              <div class="tax-city-card" data-rate="0.01" onclick="selectCity(this)">
                ä¹¡/æ‘ <div class="rate">1%</div>
              </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="apply-exempt" type="checkbox" class="checkbox" />
              <label class="small">æŒ‰å°è§„æ¨¡å…å¾è®¡ç®—ï¼ˆè‹¥ç¬¦åˆåˆ™å‹¾é€‰ï¼‰</label>
            </div>
            <div id="vat-result" class="result" tabindex="0" aria-live="polite">
              <div class="muted">è¯·åœ¨å·¦ä¾§è¾“å…¥é‡‘é¢å¹¶ç‚¹å‡»â€œè®¡ç®—â€</div>
            </div>
          </div>
        </div>

        <!-- Biz result -->
        <div>
          <div style="font-weight:700; color:var(--primary); margin-top:6px;">ä¸ªä½“å·¥å•†æˆ· è®¡ç®—ç»“æœ</div>
          <div id="biz-result" class="result" aria-live="polite">
            <div class="muted">å°šæ— ç»“æœ</div>
          </div>
        </div>

        <!-- Personal result -->
        <div>
          <div style="font-weight:700; color:var(--primary); margin-top:6px;">ä¸ªäººæ‰€å¾—ç¨ è®¡ç®—ç»“æœ</div>
          <div id="income-result" class="result" aria-live="polite">
            <div class="muted">å°šæ— ç»“æœ</div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ---- basic UI behaviors ----
    function selectCity(card){
      document.querySelectorAll('.tax-city-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
    }
    function getSelectedCityRate(){
      var sel = document.querySelector('.tax-city-card.selected');
      return sel ? parseFloat(sel.getAttribute('data-rate')) : 0.07;
    }
    function updateRateInput(){
      var sel = document.getElementById('rate-select'), inp = document.getElementById('rate');
      if(sel.value === 'other'){ inp.value = ''; inp.focus(); } else inp.value = sel.value;
    }
    function selectOtherRate(){
      var inp = document.getElementById('rate'), sel = document.getElementById('rate-select');
      var presets = ['13','11','10','9','6','3','1','0'];
      if(!presets.includes(String(inp.value))) sel.value = 'other';
    }

    // ---- VAT + surcharges calculation (keeps v16 logic) ----
    function calculateVAT(){
      var amountRaw = parseFloat(document.getElementById('amount').value);
      var mode = document.getElementById('mode').value;
      var rate = parseFloat(document.getElementById('rate').value);
      var vatResultEl = document.getElementById('vat-result');
      var cityRate = getSelectedCityRate();
      var applyExempt = document.getElementById('apply-exempt').checked;

      if(isNaN(amountRaw) || amountRaw < 0 || isNaN(rate) || rate < 0 || rate > 100){
        vatResultEl.innerHTML = '<div style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--danger')+'">è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢å’Œç¨ç‡ï¼ˆç¨ç‡ 0 - 100ï¼‰</div>';
        return;
      }

      var r = rate/100;
      var taxableBase_excl=0, vatPayable=0, totalWithVat=0, vatInside=0, amountWithoutTax=0;
      if(mode === 'exclusive'){
        taxableBase_excl = amountRaw;
        vatPayable = taxableBase_excl * r;
        totalWithVat = taxableBase_excl + vatPayable;
        vatInside = vatPayable;
        amountWithoutTax = taxableBase_excl;
      } else {
        totalWithVat = amountRaw;
        vatInside = amountRaw * r / (1 + r);
        amountWithoutTax = amountRaw / (1 + r);
        taxableBase_excl = amountWithoutTax;
        vatPayable = vatInside;
      }

      var smallScaleThreshold = 100000;
      var isSmallScaleCandidate = taxableBase_excl <= smallScaleThreshold;
      var effectiveVat = vatPayable;
      if(applyExempt && isSmallScaleCandidate) effectiveVat = 0;

      var cityTax = effectiveVat * cityRate;
      var eduTax = effectiveVat * 0.03;
      var localEduTax = effectiveVat * 0.02;
      var totalSurcharges = cityTax + eduTax + localEduTax;

      // Build result HTML (clean and structured)
      var out = '';
      if(isSmallScaleCandidate){
        out += '<div class="small-note" style="color:#b56d00;">æç¤ºï¼šæœªå«ç¨é‡‘é¢ â‰¤ Â¥' + smallScaleThreshold.toLocaleString() + 'ï¼Œå¯èƒ½ç¬¦åˆå°è§„æ¨¡å…å¾ï¼ˆä»…ä¾›å‚è€ƒï¼‰</div>';
      }

      out += '<div class="tax-type">å¢å€¼ç¨ï¼ˆ' + (mode==='exclusive' ? 'æœªå«ç¨åŸºæ•°' : 'å«ç¨å€’ç®—') + 'ï¼‰</div>';
      out += '<div class="line"><div class="muted">æœªå«ç¨é‡‘é¢ï¼ˆåŸºæ•°ï¼‰</div><div class="value">' + taxableBase_excl.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">å¢å€¼ç¨ï¼ˆ' + rate.toFixed(2) + '%ï¼‰</div><div class="value">' + vatPayable.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">å«ç¨æ€»é¢</div><div class="value">' + totalWithVat.toFixed(2) + ' å…ƒ</div></div>';

      out += '<div class="tax-type">ä»·å†…ç¨ï¼ˆå€’ç®—ç¤ºä¾‹ï¼‰</div>';
      out += '<div class="line"><div class="muted">å€’ç®—å¢å€¼ç¨</div><div class="value">' + vatInside.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">å€’ç®—æœªå«ç¨é‡‘é¢</div><div class="value">' + amountWithoutTax.toFixed(2) + ' å…ƒ</div></div>';

      out += '<div class="tax-type">é™„åŠ ç¨è´¹ï¼ˆä»¥åº”ç¼´å¢å€¼ç¨ä¸ºåŸºæ•°ï¼‰</div>';
      out += '<div class="line"><div class="muted">åŸå»ºç¨ï¼ˆ' + (cityRate*100).toFixed(2) + '%ï¼‰</div><div class="value">' + cityTax.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">æ•™è‚²è´¹é™„åŠ ï¼ˆ3%ï¼‰</div><div class="value">' + eduTax.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">åœ°æ–¹æ•™è‚²é™„åŠ ï¼ˆ2%ï¼‰</div><div class="value">' + localEduTax.toFixed(2) + ' å…ƒ</div></div>';
      out += '<div class="line"><div class="muted">é™„åŠ ç¨åˆè®¡</div><div class="value">' + totalSurcharges.toFixed(2) + ' å…ƒ</div></div>';

      if(applyExempt && isSmallScaleCandidate){
        out += '<div class="small-note" style="color:#a12b1b; margin-top:8px;"><b>æŒ‰å°è§„æ¨¡å…å¾ï¼šå¢å€¼ç¨ä¸é™„åŠ ç¨å‡è§†ä¸º 0ï¼ˆä»…åœ¨ç¨åŠ¡è®¤å®šåé€‚ç”¨ï¼‰</b></div>';
      } else if(isSmallScaleCandidate){
        out += '<div class="small-note">è‹¥ç”³æŠ¥å…å¾ï¼šå¢å€¼ç¨ã€åŸå»ºç¨ã€æ•™è‚²è´¹é™„åŠ ä¸åœ°æ–¹æ•™è‚²é™„åŠ å‡ä¸º 0ï¼ˆä¾›å¯¹æ¯”å‚è€ƒï¼‰</div>';
      }

      vatResultEl.innerHTML = out;
      vatResultEl.focus && vatResultEl.focus();
    }

    // ---- Tax calculation functions (personal & biz) ----
    function round2(v){ return Math.round((v + Number.EPSILON) * 100) / 100; }

    function getPersonalBracket(taxable){
      var rate=0,q=0,level='';
      if(taxable<=3000){ rate=3; q=0; level='ç¬¬1çº§ (â‰¤3,000)'; }
      else if(taxable<=12000){ rate=10; q=210; level='ç¬¬2çº§ (3,000~12,000)'; }
      else if(taxable<=25000){ rate=20; q=1410; level='ç¬¬3çº§ (12,000~25,000)'; }
      else if(taxable<=35000){ rate=25; q=2660; level='ç¬¬4çº§ (25,000~35,000)'; }
      else if(taxable<=55000){ rate=30; q=4410; level='ç¬¬5çº§ (35,000~55,000)'; }
      else if(taxable<=80000){ rate=35; q=7160; level='ç¬¬6çº§ (55,000~80,000)'; }
      else { rate=45; q=15160; level='ç¬¬7çº§ (>80,000)'; }
      return { rate, quickDeduction:q, level };
    }

    function getPersonalSalaryTax(salary, options){
      options = options || {};
      var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
      var keepNegative = !!options.keepNegativeTaxable;
      if(isNaN(salary) || salary < 0) throw new Error('salary å¿…é¡»ä¸ºéè´Ÿæ•°å­—');
      var taxable = round2(salary - threshold);
      if(!keepNegative && taxable < 0) taxable = 0;
      if(taxable === 0){
        return { salary:round2(salary), threshold:round2(threshold), taxable:taxable, rate:0, quickDeduction:0, tax:0, net:round2(salary), bracket:'å…ç¨' };
      }
      var bracket = getPersonalBracket(taxable);
      var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
      if(tax < 0) tax = 0;
      var net = round2(salary - tax);
      return { salary:round2(salary), threshold:round2(threshold), taxable:round2(taxable), rate:bracket.rate, quickDeduction:bracket.quickDeduction, tax, net, bracket:bracket.level };
    }

    function getBizBracketMonthly(taxable){
      var rate=0,q=0,level='';
      if(taxable<=30000){ rate=5; q=0; level='ç¬¬1çº§ (â‰¤30,000)'; }
      else if(taxable<=90000){ rate=10; q=1500; level='ç¬¬2çº§ (30,000~90,000)'; }
      else if(taxable<=300000){ rate=20; q=10500; level='ç¬¬3çº§ (90,000~300,000)'; }
      else if(taxable<=500000){ rate=30; q=40500; level='ç¬¬4çº§ (300,000~500,000)'; }
      else { rate=35; q=65500; level='ç¬¬5çº§ (>500,000)'; }
      return { rate, quickDeduction:q, level };
    }

    function getBizIncomeTaxMonthly(income, options){
      options = options || {};
      var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
      var deduction = typeof options.deduction === 'number' ? options.deduction : 0;
      var keepNegative = !!options.keepNegativeTaxable;
      if(isNaN(income) || income < 0) throw new Error('income å¿…é¡»ä¸ºéè´Ÿæ•°å­—');
      if(isNaN(deduction) || deduction < 0) deduction = 0;
      if(isNaN(threshold) || threshold < 0) threshold = 5000;
      var taxable = round2(income - threshold - deduction);
      if(!keepNegative && taxable < 0) taxable = 0;
      if(taxable === 0) return { income:round2(income), threshold:round2(threshold), deduction:round2(deduction), taxable:taxable, rate:0, quickDeduction:0, tax:0, net:round2(income), bracket:'å…ç¨' };
      var bracket = getBizBracketMonthly(taxable);
      var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
      if(tax < 0) tax = 0;
      var net = round2(income - tax);
      return { income:round2(income), threshold:round2(threshold), deduction:round2(deduction), taxable:round2(taxable), rate:bracket.rate, quickDeduction:bracket.quickDeduction, tax, net, bracket:bracket.level };
    }

    // expose for debugging
    window.getPersonalSalaryTax = getPersonalSalaryTax;
    window.getBizIncomeTaxMonthly = getBizIncomeTaxMonthly;

    // ---- page bindings ----
    function updateBizThresholdInput(){
      var sel = document.getElementById('biz-threshold-select'), inp = document.getElementById('biz-threshold');
      if(sel.value === 'other'){ inp.value=''; inp.focus(); } else inp.value = sel.value;
    }
    function updateSalaryThresholdInput(){
      var sel = document.getElementById('salary-threshold-select') || {value:'5000'}, inp = document.getElementById('salary-threshold');
      if(sel.value === 'other'){ inp.value=''; inp.focus(); } else inp.value = sel.value;
    }

    function handleCalculateBiz(){
      var income = parseFloat(document.getElementById('biz-income').value);
      var threshold = parseFloat(document.getElementById('biz-threshold').value);
      var deduction = parseFloat(document.getElementById('biz-deduct').value);
      var resEl = document.getElementById('biz-result');
      if(isNaN(income) || income < 0){ resEl.innerHTML = '<div class="err">è¯·è¾“å…¥æœ‰æ•ˆçš„ç»è¥æ”¶å…¥</div>'; return; }
      if(isNaN(threshold) || threshold < 0) threshold = 5000;
      if(isNaN(deduction) || deduction < 0) deduction = 0;
      try{
        var result = getBizIncomeTaxMonthly(income, { threshold: threshold, deduction: deduction });
        var html = '';
        html += '<div class="line"><div class="muted">ç»è¥æ”¶å…¥</div><div class="value">' + result.income.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">èµ·å¾ç‚¹</div><div class="value">' + result.threshold.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">ä¸“é¡¹æ‰£é™¤</div><div class="value">' + result.deduction.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">åº”çº³ç¨æ‰€å¾—é¢</div><div class="value">' + result.taxable.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">é€‚ç”¨ç¨ç‡</div><div class="value">' + result.rate + '%ï¼ˆ' + result.bracket + 'ï¼‰</div></div>';
        html += '<div class="line"><div class="muted">é€Ÿç®—æ‰£é™¤æ•°</div><div class="value">' + result.quickDeduction + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">åº”çº³ç¨é¢</div><div class="value" style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--danger')+'">' + result.tax.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">ç¨åæ”¶å…¥</div><div class="value" style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--success')+'">' + result.net.toFixed(2) + ' å…ƒ</div></div>';
        resEl.innerHTML = html;
      }catch(e){
        resEl.innerHTML = '<div class="err">' + e.message + '</div>';
      }
    }

    function handleCalculatePersonal(){
      var salary = parseFloat(document.getElementById('salary').value);
      var threshold = parseFloat(document.getElementById('salary-threshold').value);
      var resEl = document.getElementById('income-result');
      if(isNaN(salary) || salary < 0){ resEl.innerHTML = '<div class="err">è¯·è¾“å…¥æœ‰æ•ˆçš„ç¨å‰å·¥èµ„</div>'; return; }
      if(isNaN(threshold) || threshold < 0) threshold = 5000;
      try{
        var result = getPersonalSalaryTax(salary, { threshold: threshold });
        var html = '';
        html += '<div class="line"><div class="muted">ç¨å‰å·¥èµ„</div><div class="value">' + result.salary.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">èµ·å¾ç‚¹</div><div class="value">' + result.threshold.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">åº”çº³ç¨æ‰€å¾—é¢</div><div class="value">' + result.taxable.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">é€‚ç”¨ç¨ç‡</div><div class="value">' + result.rate + '%ï¼ˆ' + result.bracket + 'ï¼‰</div></div>';
        html += '<div class="line"><div class="muted">é€Ÿç®—æ‰£é™¤æ•°</div><div class="value">' + result.quickDeduction + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">åº”çº³ç¨é¢</div><div class="value" style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--danger')+'">' + result.tax.toFixed(2) + ' å…ƒ</div></div>';
        html += '<div class="line"><div class="muted">å®å‘å·¥èµ„</div><div class="value" style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--success')+'">' + result.net.toFixed(2) + ' å…ƒ</div></div>';
        resEl.innerHTML = html;
      }catch(e){
        resEl.innerHTML = '<div class="err">' + e.message + '</div>';
      }
    }

    // init values
    (function init(){
      // default thresholds
      var bizThreshold = document.getElementById('biz-threshold');
      var salaryThreshold = document.getElementById('salary-threshold');
      if(bizThreshold) bizThreshold.value = '5000';
      if(salaryThreshold) salaryThreshold.value = '5000';
      // ensure one selected city
      if(!document.querySelector('.tax-city-card.selected')){
        var f = document.querySelector('.tax-city-card');
        if(f) f.classList.add('selected');
      }
    })();
  </script>
</body>
</html>
