<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>ä¸­å›½ç¨è´¹è®¡ç®—å™¨ï¼ˆv16 - å«å¢å€¼ç¨é™„åŠ ä¸æ‰€å¾—ç¨è®¡ç®—ï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: "Segoe UI", "PingFang SC", Arial, sans-serif;
            background: linear-gradient(120deg, #eaf4ff 0%, #f7f7f7 100%);
            margin: 0;
            min-height: 100vh;
        }
        .container {
            background: #fff;
            padding: 26px 20px;
            border-radius: 12px;
            max-width: 820px;
            margin: 30px auto;
            box-shadow: 0 8px 36px rgba(47, 91, 216, 0.08);
        }
        h2 {
            text-align: center;
            color: #2f5bd8;
            margin-bottom: 12px;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .section-title {
            font-size: 1.02rem;
            color: #1e4aa7;
            margin: 16px 0 8px;
            font-weight: 700;
            border-left: 4px solid #3d5afe;
            padding-left: 10px;
        }
        label { display:block; margin:8px 0 6px; color:#2a5ea6; font-size:0.98rem; }
        .flex-row { display:flex; gap:10px; align-items:center; }
        .flex-row > * { flex:1; }
        input[type="number"], select {
            padding:10px 12px;
            border-radius:8px;
            border:1.2px solid #d6e7ff;
            background:#fbfeff;
            font-size:1rem;
            outline:none;
        }
        input[type="number"]:focus, select:focus { border-color:#3d5afe; box-shadow:0 6px 18px rgba(61,90,254,0.06); }
        .amount-short { width:190px; max-width:46%; }
        .rate-input { max-width:150px; }
        .btn { width:100%; padding:12px; background:linear-gradient(90deg,#3d5afe 40%, #6fb7ff 100%); color:#fff; border:none; border-radius:10px; cursor:pointer; font-size:1rem; margin-top:12px; }
        .result { margin-top:14px; padding:12px; border-radius:8px; background:linear-gradient(180deg,#fbfeff,#f5fbff); box-shadow:0 6px 18px rgba(19,87,209,0.04); font-size:1rem; }
        .tax-type { font-weight:700; margin:10px 0 6px; color:#2a5ea6; }
        .hint { color:#ff9800; font-weight:600; margin:8px 0; }
        .err { color:#d32f2f; font-weight:700; padding:8px 0; text-align:center; }
        /* åŸå»ºç¨å¡ç‰‡ */
        .tax-city-row { display:flex; gap:10px; margin:10px 0; }
        .tax-city-card { flex:1; text-align:center; padding:8px 6px; border-radius:8px; border:1.2px solid #e6f0ff; background:#fbfeff; cursor:pointer; transition:all .15s; user-select:none; }
        .tax-city-card.selected { border-color:#3d5afe; background:linear-gradient(180deg,#eaf2ff,#e1f0ff); box-shadow:0 6px 16px rgba(61,90,254,0.07); color:#2a4fc6; font-weight:700; }
        .tax-city-name { color:#1f4ea0; font-size:0.98rem; }
        .tax-city-rate { color:#2e7d32; margin-top:6px; font-weight:700; }
        .small-row { display:flex; gap:10px; align-items:center; margin-top:8px; }
        .small-row > * { flex: none; }
        .checkbox { transform:scale(1.05); margin-right:6px; vertical-align:middle; }

        /* ä¸¤æ å¸ƒå±€ */
        .columns { display:flex; gap:20px; flex-wrap:wrap; }
        .col { flex:1; min-width:300px; }

        @media (max-width:900px) {
            .container{padding:18px;margin:16px;}
            .amount-short{width:130px;}
            .rate-input{max-width:120px;}
            .tax-city-row{gap:6px;}
            .columns { flex-direction:column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ä¸­å›½ç¨è´¹è®¡ç®—å™¨ï¼ˆv16ï¼‰</h2>

        <div class="columns">
            <!-- å·¦åˆ—ï¼šå¢å€¼ç¨ -->
            <div class="col">
                <div class="section-title">å¢å€¼ç¨è®¡ç®—</div>

                <label for="amount">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <div class="flex-row">
                    <input type="number" id="amount" class="amount-short" min="0" step="0.01" placeholder="é‡‘é¢" />
                    <select id="mode" title="é‡‘é¢æ¨¡å¼" style="max-width:160px;">
                        <option value="exclusive">æœªå«ç¨ï¼ˆåŸºæ•°ï¼‰</option>
                        <option value="inclusive">å«ç¨ï¼ˆå€’ç®—ï¼‰</option>
                    </select>
                </div>

                <label for="rate-select">ç¨ç‡</label>
                <div class="flex-row">
                    <select id="rate-select" onchange="updateRateInput()">
                        <option value="13">13%</option>
                        <option value="11">11%</option>
                        <option value="10">10%</option>
                        <option value="9">9%</option>
                        <option value="6">6%</option>
                        <option value="3">3%</option>
                        <option value="1">1%</option>
                        <option value="0">0%</option>
                        <option value="other">è‡ªå®šä¹‰</option>
                    </select>
                    <input type="number" id="rate" class="rate-input" min="0" max="100" step="0.01" value="13" oninput="selectOtherRate()" />
                </div>

                <div class="section-title" style="margin-top:12px;">åŸå»ºç¨ / é™„åŠ è´¹è®¾ç½®</div>
                <div style="font-size:0.95rem; color:#1565c0; margin-bottom:6px;">é€‰æ‹©åŸå»ºç¨é€‚ç”¨åŒºåŸŸï¼ˆæ•™è‚²è´¹é™„åŠ  3%ï¼Œåœ°æ–¹æ•™è‚²é™„åŠ  2%ï¼ŒæŒ‰å·²ç¼´å¢å€¼ç¨é¢è®¡å¾ï¼‰</div>
                <div class="tax-city-row" id="tax-city-row">
                    <div class="tax-city-card selected" data-rate="0.07" onclick="selectCity(this)">
                        <div class="tax-city-name">åŸå¸‚</div>
                        <div class="tax-city-rate">åŸå»ºç¨ 7%</div>
                    </div>
                    <div class="tax-city-card" data-rate="0.05" onclick="selectCity(this)">
                        <div class="tax-city-name">å¿/é•‡</div>
                        <div class="tax-city-rate">åŸå»ºç¨ 5%</div>
                    </div>
                    <div class="tax-city-card" data-rate="0.01" onclick="selectCity(this)">
                        <div class="tax-city-name">ä¹¡/æ‘</div>
                        <div class="tax-city-rate">åŸå»ºç¨ 1%</div>
                    </div>
                </div>

                <div class="small-row" style="margin-top:6px;">
                    <input type="checkbox" id="apply-exempt" class="checkbox" />
                    <label for="apply-exempt" style="margin:0;">æŒ‰å°è§„æ¨¡å…å¾è®¡ç®—ï¼ˆè‹¥ç¬¦åˆå°è§„æ¨¡çº³ç¨äººå…å¾æ¡ä»¶ï¼Œåˆ™å‹¾é€‰ï¼‰</label>
                </div>

                <div style="font-size:0.92rem; color:#666; margin-top:8px;">
                    å°è§„æ¨¡å…å¾å‚è€ƒé˜ˆå€¼ï¼šæœªå«ç¨æœˆé”€å”®é¢ â‰¤ Â¥100,000ï¼ˆä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆä»¥ç¨åŠ¡æœºå…³è®¤å®šä¸ºå‡†ï¼‰
                </div>

                <button class="btn" onclick="calculateVAT()">ğŸ’° è®¡ç®—å¢å€¼ç¨ä¸é™„åŠ ç¨</button>

                <div class="result" id="vat-result" aria-live="polite"></div>
            </div>

            <!-- å³åˆ—ï¼šä¸ªä½“ä¸ä¸ªäººæ‰€å¾—ç¨ï¼ˆä¿ç•™ï¼‰ -->
            <div class="col">
                <!-- ä¸ªä½“å·¥å•†æˆ·æ‰€å¾—ç¨ï¼ˆæœˆåº¦ï¼‰ -->
                <div class="section-title">ä¸ªä½“å·¥å•†æˆ·æ‰€å¾—ç¨è®¡ç®—ï¼ˆæœˆåº¦ï¼‰</div>

                <label for="biz-income">ç»è¥æ”¶å…¥ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="biz-income" min="0" step="0.01" placeholder="è¯·è¾“å…¥ç»è¥æ”¶å…¥" />

                <div class="flex-row" style="margin-top:6px;">
                    <label style="margin:0;">æœˆåº¦èµ·å¾ç‚¹</label>
                    <select id="biz-threshold-select" onchange="updateBizThresholdInput()" style="max-width:160px;">
                        <option value="5000">5000å…ƒ</option>
                        <option value="10000">10000å…ƒ</option>
                        <option value="20000">20000å…ƒ</option>
                        <option value="30000">30000å…ƒ</option>
                        <option value="other">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="flex-row" style="margin-top:8px;">
                    <input type="number" id="biz-threshold" min="0" step="0.01" placeholder="è‡ªå®šä¹‰èµ·å¾ç‚¹" value="5000" />
                    <input type="number" id="biz-deduct" min="0" step="0.01" placeholder="ä¸“é¡¹æ‰£é™¤ï¼ˆå¯é€‰ï¼‰" />
                </div>

                <button class="btn" onclick="handleCalculateBiz()">ğŸ¢ è®¡ç®—ä¸ªä½“å·¥å•†æˆ·æ‰€å¾—ç¨</button>
                <div class="result" id="biz-result" aria-live="polite"></div>

                <!-- ä¸ªäººæ‰€å¾—ç¨ï¼ˆå·¥èµ„è–ªé‡‘ï¼‰ -->
                <div class="section-title" style="margin-top:18px;">ä¸ªäººæ‰€å¾—ç¨è®¡ç®—ï¼ˆå·¥èµ„è–ªé‡‘ï¼‰</div>

                <label for="salary">ç¨å‰å·¥èµ„ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="salary" min="0" step="0.01" placeholder="è¯·è¾“å…¥ç¨å‰å·¥èµ„" />

                <div class="flex-row" style="margin-top:6px;">
                    <label style="margin:0;">èµ·å¾ç‚¹</label>
                    <select id="salary-threshold-select" onchange="updateSalaryThresholdInput()" style="max-width:160px;">
                        <option value="5000">5000å…ƒï¼ˆé»˜è®¤ï¼‰</option>
                        <option value="8000">8000å…ƒ</option>
                        <option value="10000">10000å…ƒ</option>
                        <option value="other">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="flex-row" style="margin-top:8px;">
                    <input type="number" id="salary-threshold" min="0" step="0.01" placeholder="è‡ªå®šä¹‰èµ·å¾ç‚¹" value="5000" />
                    <div style="flex:1"></div>
                </div>

                <button class="btn" onclick="handleCalculatePersonal()">ğŸ§¾ è®¡ç®—ä¸ªäººæ‰€å¾—ç¨</button>
                <div class="result" id="income-result" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <script>
        /* ---------------------
           åŸå»ºç¨å¡ç‰‡ä¸ç¨ç‡é€‰æ‹©é€»è¾‘
           --------------------- */
        function selectCity(card) {
            document.querySelectorAll('.tax-city-card').forEach(function(c){ c.classList.remove('selected'); });
            card.classList.add('selected');
        }
        function getSelectedCityRate() {
            var sel = document.querySelector('.tax-city-card.selected');
            return sel ? parseFloat(sel.getAttribute('data-rate')) : 0.07;
        }

        function updateRateInput() {
            var sel = document.getElementById('rate-select');
            var input = document.getElementById('rate');
            if (sel.value === 'other') {
                input.value = '';
                input.focus();
            } else {
                input.value = sel.value;
            }
        }
        function selectOtherRate() {
            var input = document.getElementById('rate');
            var sel = document.getElementById('rate-select');
            var presets = ['13','11','10','9','6','3','1','0'];
            if (!presets.includes(String(input.value))) sel.value = 'other';
        }

        /* ---------------------
           å¢å€¼ç¨ + é™„åŠ ç¨ è®¡ç®—ï¼ˆv16 è¦æ±‚ï¼‰
           --------------------- */
        function calculateVAT() {
            var amountRaw = parseFloat(document.getElementById('amount').value);
            var mode = document.getElementById('mode').value; // exclusive | inclusive
            var rate = parseFloat(document.getElementById('rate').value);
            var vatResultEl = document.getElementById('vat-result');
            var cityRate = getSelectedCityRate();
            var applyExempt = document.getElementById('apply-exempt').checked;

            if (isNaN(amountRaw) || amountRaw < 0 || isNaN(rate) || rate < 0 || rate > 100) {
                vatResultEl.innerHTML = '<div class="err">è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢å’Œç¨ç‡ï¼ˆç¨ç‡ 0 - 100ï¼‰</div>';
                return;
            }

            var r = rate / 100;
            var taxableBase_excl = 0;
            var vatPayable = 0;
            var totalWithVat = 0;
            var vatInside = 0;
            var amountWithoutTax = 0;

            if (mode === 'exclusive') {
                taxableBase_excl = amountRaw;
                vatPayable = taxableBase_excl * r;
                totalWithVat = taxableBase_excl + vatPayable;
                vatInside = vatPayable;
                amountWithoutTax = taxableBase_excl;
            } else {
                totalWithVat = amountRaw;
                vatInside = amountRaw * r / (1 + r);
                amountWithoutTax = amountRaw / (1 + r);
                taxableBase_excl = amountWithoutTax;
                vatPayable = vatInside;
            }

            // å°è§„æ¨¡å…å¾å‚è€ƒé˜ˆå€¼ï¼ˆæç¤ºï¼‰
            var smallScaleThreshold = 100000; // 10 ä¸‡
            var isSmallScaleCandidate = taxableBase_excl <= smallScaleThreshold;
            var smallScaleHint = isSmallScaleCandidate ? ('<div class="hint">æç¤ºï¼šè¯¥æœªå«ç¨é‡‘é¢ â‰¤ Â¥' + smallScaleThreshold.toLocaleString() + 'ï¼Œå¯èƒ½ç¬¦åˆå°è§„æ¨¡çº³ç¨äººå…å¾æ¡ä»¶ï¼ˆä»…ä¾›å‚è€ƒï¼‰ã€‚</div>') : '';

            // å¦‚æœç”¨æˆ·å‹¾é€‰å…å¾å¹¶ä¸”ä¸ºå€™é€‰ï¼Œåˆ™å®é™…åº”ç¼´ä¸º0
            var effectiveVat = vatPayable;
            if (applyExempt && isSmallScaleCandidate) effectiveVat = 0;

            // é™„åŠ ç¨è´¹ï¼ˆæŒ‰å·²ç¼´å¢å€¼ç¨é¢è®¡å¾ï¼‰
            var cityTax = effectiveVat * cityRate;
            var eduSurcharge = effectiveVat * 0.03;      // æ•™è‚²è´¹é™„åŠ  3%
            var localEduSurcharge = effectiveVat * 0.02; // åœ°æ–¹æ•™è‚²é™„åŠ  2%
            var totalSurcharges = cityTax + eduSurcharge + localEduSurcharge;

            // æ„å»ºè¾“å‡º HTML
            var html = '';
            if (smallScaleHint) html += smallScaleHint;

            html += '<div class="tax-type">å¢å€¼ç¨ï¼ˆ' + (mode === 'exclusive' ? 'æœªå«ç¨åŸºæ•°' : 'å«ç¨é‡‘é¢å€’ç®—') + 'ï¼‰</div>';
            html += '<div>æœªå«ç¨é‡‘é¢ï¼ˆåŸºæ•°ï¼‰ï¼š <b style="color:#1565c0;">' + taxableBase_excl.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div>å¢å€¼ç¨ï¼ˆç¨ç‡ ' + rate.toFixed(2) + '%ï¼‰ï¼š <b style="color:#43a047;">' + vatPayable.toFixed(2) + '</b> å…ƒ</div>';
            if (applyExempt && isSmallScaleCandidate) {
                html += '<div style="color:#e65100; margin-top:6px;"><b>å·²æŒ‰å°è§„æ¨¡å…å¾ï¼šå¢å€¼ç¨åŠé™„åŠ ç¨å‡è®¡ä¸º 0.00 å…ƒï¼ˆä»…åœ¨ç¬¦åˆæ¡ä»¶å¹¶ç»ç¨åŠ¡æœºå…³è®¤å®šæ—¶é€‚ç”¨ï¼‰</b></div>';
            }
            html += '<div>å«ç¨æ€»é¢ï¼š <b style="color:#3d5afe;">' + totalWithVat.toFixed(2) + '</b> å…ƒ</div>';

            html += '<div class="tax-type">ä»·å†…ç¨ï¼ˆå€’ç®—ç¤ºä¾‹ï¼‰</div>';
            html += '<div>å«ç¨é‡‘é¢ï¼š <b style="color:#1565c0;">' + totalWithVat.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div>å€’ç®—å¢å€¼ç¨ï¼š <b style="color:#e65100;">' + vatInside.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div>å€’ç®—æœªå«ç¨é‡‘é¢ï¼š <b style="color:#00838f;">' + amountWithoutTax.toFixed(2) + '</b> å…ƒ</div>';

            html += '<div class="tax-type">é™„åŠ ç¨è´¹ï¼ˆæŒ‰å·²ç¼´å¢å€¼ç¨é¢è®¡å¾ï¼‰</div>';
            html += '<div>åŸå»ºç¨ï¼ˆé€‚ç”¨ç‡ ' + (cityRate * 100).toFixed(2) + '%ï¼‰ï¼š <b>' + cityTax.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div>æ•™è‚²è´¹é™„åŠ ï¼ˆ3%ï¼‰ï¼š <b>' + eduSurcharge.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div>åœ°æ–¹æ•™è‚²é™„åŠ ï¼ˆ2%ï¼‰ï¼š <b>' + localEduSurcharge.toFixed(2) + '</b> å…ƒ</div>';
            html += '<div style="margin-top:6px;">é™„åŠ ç¨åˆè®¡ï¼š <b style="color:#e65100;">' + totalSurcharges.toFixed(2) + '</b> å…ƒ</div>';

            if (isSmallScaleCandidate && !applyExempt) {
                html += '<div class="tax-type" style="margin-top:10px;">è‹¥ç”³æŠ¥å°è§„æ¨¡å…å¾ï¼ˆå‚è€ƒï¼‰</div>';
                html += '<div>å¢å€¼ç¨ï¼š<b style="color:#43a047;">0.00</b> å…ƒ</div>';
                html += '<div>åŸå»ºç¨ï¼š<b>0.00</b> å…ƒï¼›æ•™è‚²è´¹é™„åŠ ï¼š<b>0.00</b> å…ƒï¼›åœ°æ–¹æ•™è‚²é™„åŠ ï¼š<b>0.00</b> å…ƒ</div>';
                html += '<div class="hint" style="margin-top:6px;">æ³¨ï¼šæ˜¯å¦å…å¾ä»¥ç¨åŠ¡æœºå…³è®¤å®šä¸ºå‡†ï¼Œæœ¬å·¥å…·ä»…ä½œå‚è€ƒã€‚</div>';
            }

            vatResultEl.innerHTML = html;
            vatResultEl.focus && vatResultEl.focus();
        }

        /* =========================
           æ‰€å¾—ç¨è®¡ç®—ï¼ˆåµŒå…¥ v16 é¡µé¢ï¼‰
           åŒ…æ‹¬ï¼š
           - getPersonalSalaryTax
           - getBizIncomeTaxMonthly
           å¹¶æä¾›é¡µé¢è°ƒç”¨å¤„ç†å‡½æ•°
           ========================= */

        function round2(v) {
          return Math.round((v + Number.EPSILON) * 100) / 100;
        }

        function getPersonalBracket(taxable) {
          var rate = 0, q = 0, level = '';
          if (taxable <= 3000) {
            rate = 3; q = 0; level = 'ç¬¬1çº§ (â‰¤3,000)';
          } else if (taxable <= 12000) {
            rate = 10; q = 210; level = 'ç¬¬2çº§ (3,000~12,000)';
          } else if (taxable <= 25000) {
            rate = 20; q = 1410; level = 'ç¬¬3çº§ (12,000~25,000)';
          } else if (taxable <= 35000) {
            rate = 25; q = 2660; level = 'ç¬¬4çº§ (25,000~35,000)';
          } else if (taxable <= 55000) {
            rate = 30; q = 4410; level = 'ç¬¬5çº§ (35,000~55,000)';
          } else if (taxable <= 80000) {
            rate = 35; q = 7160; level = 'ç¬¬6çº§ (55,000~80,000)';
          } else {
            rate = 45; q = 15160; level = 'ç¬¬7çº§ (>80,000)';
          }
          return { rate: rate, quickDeduction: q, level: level };
        }

        function getPersonalSalaryTax(salary, options) {
          options = options || {};
          var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
          var keepNegative = !!options.keepNegativeTaxable;

          if (isNaN(salary) || salary < 0) {
            throw new Error('salary å¿…é¡»ä¸ºéè´Ÿæ•°å­—');
          }

          var taxable = round2(salary - threshold);
          if (!keepNegative && taxable < 0) taxable = 0;

          if (taxable === 0) {
            return {
              salary: round2(salary),
              threshold: round2(threshold),
              taxable: taxable,
              rate: 0,
              quickDeduction: 0,
              tax: 0,
              net: round2(salary),
              bracket: 'å…ç¨'
            };
          }

          var bracket = getPersonalBracket(taxable);
          var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
          if (tax < 0) tax = 0;
          var net = round2(salary - tax);

          return {
            salary: round2(salary),
            threshold: round2(threshold),
            taxable: round2(taxable),
            rate: bracket.rate,
            quickDeduction: bracket.quickDeduction,
            tax: tax,
            net: net,
            bracket: bracket.level
          };
        }

        function getBizBracketMonthly(taxable) {
          var rate = 0, q = 0, level = '';
          if (taxable <= 30000) {
            rate = 5; q = 0; level = 'ç¬¬1çº§ (â‰¤30,000)';
          } else if (taxable <= 90000) {
            rate = 10; q = 1500; level = 'ç¬¬2çº§ (30,000~90,000)';
          } else if (taxable <= 300000) {
            rate = 20; q = 10500; level = 'ç¬¬3çº§ (90,000~300,000)';
          } else if (taxable <= 500000) {
            rate = 30; q = 40500; level = 'ç¬¬4çº§ (300,000~500,000)';
          } else {
            rate = 35; q = 65500; level = 'ç¬¬5çº§ (>500,000)';
          }
          return { rate: rate, quickDeduction: q, level: level };
        }

        function getBizIncomeTaxMonthly(income, options) {
          options = options || {};
          var threshold = typeof options.threshold === 'number' ? options.threshold : 5000;
          var deduction = typeof options.deduction === 'number' ? options.deduction : 0;
          var keepNegative = !!options.keepNegativeTaxable;

          if (isNaN(income) || income < 0) {
            throw new Error('income å¿…é¡»ä¸ºéè´Ÿæ•°å­—');
          }
          if (isNaN(deduction) || deduction < 0) deduction = 0;
          if (isNaN(threshold) || threshold < 0) threshold = 5000;

          var taxable = round2(income - threshold - deduction);
          if (!keepNegative && taxable < 0) taxable = 0;

          if (taxable === 0) {
            return {
              income: round2(income),
              threshold: round2(threshold),
              deduction: round2(deduction),
              taxable: taxable,
              rate: 0,
              quickDeduction: 0,
              tax: 0,
              net: round2(income),
              bracket: 'å…ç¨'
            };
          }

          var bracket = getBizBracketMonthly(taxable);
          var tax = round2(taxable * bracket.rate / 100 - bracket.quickDeduction);
          if (tax < 0) tax = 0;
          var net = round2(income - tax);

          return {
            income: round2(income),
            threshold: round2(threshold),
            deduction: round2(deduction),
            taxable: round2(taxable),
            rate: bracket.rate,
            quickDeduction: bracket.quickDeduction,
            tax: tax,
            net: net,
            bracket: bracket.level
          };
        }

        // æš´éœ²åˆ° window å…¨å±€
        window.getPersonalSalaryTax = getPersonalSalaryTax;
        window.getBizIncomeTaxMonthly = getBizIncomeTaxMonthly;

        /* =========================
           é¡µé¢äº¤äº’ï¼šæ˜¾ç¤ºä¸ªä½“ä¸ä¸ªäººæ‰€å¾—ç¨è®¡ç®—ç»“æœ
           ========================= */

        function updateBizThresholdInput() {
            var select = document.getElementById('biz-threshold-select');
            var input = document.getElementById('biz-threshold');
            if (select.value === "other") {
                input.value = "";
                input.focus();
            } else {
                input.value = select.value;
            }
        }
        function updateSalaryThresholdInput() {
            var select = document.getElementById('salary-threshold-select');
            var input = document.getElementById('salary-threshold');
            if (select.value === "other") {
                input.value = "";
                input.focus();
            } else {
                input.value = select.value;
            }
        }

        function handleCalculateBiz() {
            var income = parseFloat(document.getElementById('biz-income').value);
            var threshold = parseFloat(document.getElementById('biz-threshold').value);
            var deduction = parseFloat(document.getElementById('biz-deduct').value);
            var resEl = document.getElementById('biz-result');

            if (isNaN(income) || income < 0) {
                resEl.innerHTML = '<div class="err">è¯·è¾“å…¥æœ‰æ•ˆçš„ç»è¥æ”¶å…¥</div>';
                return;
            }
            if (isNaN(threshold) || threshold < 0) threshold = 5000;
            if (isNaN(deduction) || deduction < 0) deduction = 0;

            try {
                var result = getBizIncomeTaxMonthly(income, { threshold: threshold, deduction: deduction });
                var html = '<div class="tax-type">ä¸ªä½“å·¥å•†æˆ·æ‰€å¾—ç¨ï¼ˆæœˆåº¦ï¼‰</div>';
                html += '<div>ç»è¥æ”¶å…¥ï¼š <b>' + result.income.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>èµ·å¾ç‚¹ï¼š <b>' + result.threshold.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>ä¸“é¡¹æ‰£é™¤ï¼š <b>' + result.deduction.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>åº”çº³ç¨æ‰€å¾—é¢ï¼š <b>' + result.taxable.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>é€‚ç”¨ç¨ç‡ï¼š <b>' + result.rate + '%</b>ï¼ˆ' + result.bracket + 'ï¼Œé€Ÿç®—æ‰£é™¤æ•°ï¼š' + result.quickDeduction + ' å…ƒï¼‰</div>';
                html += '<div>åº”çº³ç¨é¢ï¼š <b style="color:#e65100;">' + result.tax.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>ç¨åæ”¶å…¥ï¼š <b style="color:#43a047;">' + result.net.toFixed(2) + '</b> å…ƒ</div>';
                resEl.innerHTML = html;
            } catch (e) {
                resEl.innerHTML = '<div class="err">' + e.message + '</div>';
            }
        }

        function handleCalculatePersonal() {
            var salary = parseFloat(document.getElementById('salary').value);
            var threshold = parseFloat(document.getElementById('salary-threshold').value);
            var resEl = document.getElementById('income-result');

            if (isNaN(salary) || salary < 0) {
                resEl.innerHTML = '<div class="err">è¯·è¾“å…¥æœ‰æ•ˆçš„ç¨å‰å·¥èµ„</div>';
                return;
            }
            if (isNaN(threshold) || threshold < 0) threshold = 5000;

            try {
                var result = getPersonalSalaryTax(salary, { threshold: threshold });
                var html = '<div class="tax-type">ä¸ªäººæ‰€å¾—ç¨ï¼ˆå·¥èµ„è–ªé‡‘ï¼‰</div>';
                html += '<div>ç¨å‰å·¥èµ„ï¼š <b>' + result.salary.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>èµ·å¾ç‚¹ï¼š <b>' + result.threshold.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>åº”çº³ç¨æ‰€å¾—é¢ï¼š <b>' + result.taxable.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>é€‚ç”¨ç¨ç‡ï¼š <b>' + result.rate + '%</b>ï¼ˆ' + result.bracket + 'ï¼Œé€Ÿç®—æ‰£é™¤æ•°ï¼š' + result.quickDeduction + ' å…ƒï¼‰</div>';
                html += '<div>åº”çº³ç¨é¢ï¼š <b style="color:#e65100;">' + result.tax.toFixed(2) + '</b> å…ƒ</div>';
                html += '<div>å®å‘å·¥èµ„ï¼š <b style="color:#43a047;">' + result.net.toFixed(2) + '</b> å…ƒ</div>';
                resEl.innerHTML = html;
            } catch (e) {
                resEl.innerHTML = '<div class="err">' + e.message + '</div>';
            }
        }

        // init: ensure selected city card
        (function(){ if (!document.querySelector('.tax-city-card.selected')) { var f=document.querySelector('.tax-city-card'); if (f) f.classList.add('selected'); } })();
    </script>
</body>
</html>
